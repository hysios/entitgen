# Entitgen - protobuf Message 与 gorm Model 互换生成器

在 grpc 微服务中，protobuf Message 是与我们外部交互的消息结构体，然后我们实现的业务是在 gorm Model 中进行的，这两者之间的需要非常频繁的转换，但是每次都要手动写转换代码，非常繁琐，所以我写了这个工具，可以自动生成转换代码。

我们使用 go generate 生成模拟来生产转化代码，这种方法非常的高效，优于使用反射的方式，并且生成清晰可读的代码，方便调试。

## 安装

```bash
go get -u github.com/hysios/entitgen
```

## 命令参数

```
entitgen -gen $(DEMO_DIR)/out -pkg out -proto-gen-path $(DEMO_DIR)/gen/proto -type User -model User -O "suppress=Permissions"
```

- -gen: 生成代码的目录, 生成 gorm Model 代码到这个目录，生成的文件带有 .entity.go 的后缀，以区别用户使用的模型代码, (如: user.go 的 User 模型会生成 user.entity.go )
- -pkg: 生成代码的包名, 默认会从目录名自动推断出包名，但也可以自己指定
- -proto-gen-path: protoc-gen-go 的生成目录，用于获取 protobuf Message 的类型信息， 也可以使用 -G 快捷参数指定
- -type: protobuf Message 的类型名，也可以使用 -T 快捷参数指定， 这个是主要交换的 protobuf 类型
- -model: gorm Model 的类型名，也可以使用 -M 快捷参数指定， 这个是主要交换的 gorm Model 类型
- -option: 控制选项, 使用 key=value 的形式，支持多个选项，如: -O "option1=value1" -O "option2=value2"
  - suppress: 用于控制不生成的字段，多个字段用逗号分隔，如: -O "suppress=Permissions,Password"
  - no_models: 不生成 gorm Model 代码，只生成 protobuf Message 与 gorm Model 之间的转换代码

## 使用
首先在 model 目录下创建你需要转换的 protobuf Message 对应的 gorm Model 类型，如: user.go
然后增加一行 generate 注解
```go
package model

//go:generate entitgen -proto-gen-path $PROJECT/gen/proto -type User -model User -O "suppress=Permissions"
```

注：这里使用的环境变量 $PROJECT 是一个演示，实际使用时需要替换成你自己的路径，也可以使用相对路径。

一般情况情况下，我们只需要最少一个参数，如下：
```go
//go:generate entitgen -type User
```
entitgen 将从默认项目的 ./gen/proto 目录或环境变量 `GOPROTO_GEN_PATH` 下查找 protobuf Message 的类型信息，-model 从 -type 自动推断出来，-pkg 从目录名自动推断出来，-gen 等于当前目录。

例子：如 example/out/member.entity.go 从 example/gen/proto/user.pb.go 生成

```go
// Code generated by entitgen. DO NOT EDIT.
package out

import (
	"time"

	pb "github.com/hysios/entitgen/example/gen/proto"
	"google.golang.org/protobuf/types/known/timestamppb"
)

type Member struct {
	ID           uint
	UserID       uint
	EnterpriseID uint
	User         *User
	CreatedAt    time.Time
	UpdatedAt    time.Time
}

// ToProto converts the model to protobuf type.
func (m *Member) ToProto() *pb.Member {
	return &pb.Member{
		Id:           uint32(m.ID),
		UserId:       uint32(m.UserID),
		EnterpriseId: uint32(m.EnterpriseID),
		User:         m.User.ToProto(),
		CreatedAt:    timestamppb.New(m.CreatedAt),
		UpdatedAt:    timestamppb.New(m.UpdatedAt),
	}
}

// FromProto converts the protobuf type to model.
func (m *Member) FromProto(pMember *pb.Member) *Member {
	return &Member{
		ID:           uint(pMember.Id),
		UserID:       uint(pMember.UserId),
		EnterpriseID: uint(pMember.EnterpriseId),
		User:         (*User)(nil).FromProto(pMember.User),
		CreatedAt:    pMember.CreatedAt.AsTime(),
		UpdatedAt:    pMember.UpdatedAt.AsTime(),
	}
}

func MemberFromProto(pMember *pb.Member) *Member {
	return (*Member)(nil).FromProto(pMember)
}
```

在 service 层，我们可以直接使用 protobuf Message 与 gorm Model 之间的转换代码，如：

```go
func (s *Service) GetMember(ctx context.Context, req *pb.GetMemberRequest) (*pb.Member, error) {
    member, err := s.repo.GetMember(ctx, req.Id)
    if err != nil {
        return nil, err
    }
    return member.ToProto(), nil
}
```

`ToProto()` 将 gorm Model 转换成 protobuf Message

```go
func (s *Service) CreateMember(ctx context.Context, req *pb.CreateMemberRequest) (*pb.Member, error) {
    member := (*model.Member)(nil).FromProto(req.Member)
    // 或者使用下面的更友好的方式
    member := model.MemberFromProto(req.Member) // 也可以使用这种方式
    err := s.repo.CreateMember(ctx, member)
    if err != nil {
        return nil, err
    }
    return member.ToProto(), nil
}
```

`FromProto()` 将 protobuf Message 转换成 gorm Model

`XXXFromProto()` 从 protobuf Message 转换成 gorm Model 的静态方法

使用 `go generate` 生成代码，可以在开发时自动更新，非常方便。

## 参考资料
1. https://go.dev/blog/generate 
2. https://eli.thegreenplace.net/2021/a-comprehensive-guide-to-go-generate/


